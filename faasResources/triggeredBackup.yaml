apiVersion: "nuclio.io/v1"
kind: Function
metadata:
  name: triggeredbackup
  namespace: nuclio
spec:
  handler: "main:handler"
  description: "Function the is called when a new message is arrived on the iot/rooms queue, //the function updates free seats for each room and then sends back free seates on the seatsBackup queue."
  runtime: nodejs
  image: "nuclio/processor-triggeredbackup:latest"
  minReplicas: 1
  maxReplicas: 1
  targetCPU: 75
  triggers:
    amqp:
      class: ""
      kind: rabbit-mq
      url: "amqp://guest:guest@10.0.2.15:5672"
      attributes:
        exchangeName: iot/rooms
        queueName: iot/rooms
        topics:
         - rooms
  build:
    functionSourceCode: dmFyIGFtcXAgPSByZXF1aXJlKCdhbXFwbGliJyk7CnZhciBCQUNLVVBfUVVFVUUgPSAic2VhdHNCYWNrdXAiOwp2YXIgYmFja3VwX21zZzsgICAgCnZhciBpb3Rfc2VhdHNfbXNnOwp2YXIgbmV3X2JhY2t1cF9tc2c7CgpleHBvcnRzLmhhbmRsZXIgPSBmdW5jdGlvbihjb250ZXh0LCBldmVudCkgewogICAgdmFyIF9ldmVudCA9IEpTT04ucGFyc2UoSlNPTi5zdHJpbmdpZnkoZXZlbnQpKTsvL2RhdGEgY29taW5nIGZyb20gcm9vbXNUcmFja2luZyBxdWV1ZQogICAgaW90X3NlYXRzX21zZyA9IGJpbjJzdHJpbmcoX2V2ZW50LmJvZHkuZGF0YSk7Ly9mb3JtYXR0ZWQgc3RyaW5nIGV4LiAxLXRydWUKICAgIAogICAgY29udGV4dC5jYWxsYmFjaygib2tUcmlnZ2VyIik7CiAgICBjb25zdW1lX2JhY2t1cF9tc2coKTsKICAgIAp9OwoKZnVuY3Rpb24gY29uc3VtZV9iYWNrdXBfbXNnKCl7CglhbXFwLmNvbm5lY3QoJ2FtcXA6Ly9ndWVzdDpndWVzdEAxMC4wLjIuMTU6NTY3MicpLnRoZW4oZnVuY3Rpb24oY29ubikgewogIAoJcmV0dXJuIGNvbm4uY3JlYXRlQ2hhbm5lbCgpLnRoZW4oZnVuY3Rpb24oY2gpIHsKCgl2YXIgb2sgPSBjaC5hc3NlcnRRdWV1ZShCQUNLVVBfUVVFVUUsIHtkdXJhYmxlOmZhbHNlfSk7CgoJb2sgPSBvay50aGVuKGZ1bmN0aW9uKF9xb2spIHsKCSAgcmV0dXJuIGNoLmNvbnN1bWUoQkFDS1VQX1FVRVVFLCBmdW5jdGlvbihtc2cpIHsKCQkgICAgYmFja3VwX21zZyA9IG1zZy5jb250ZW50LnRvU3RyaW5nKCk7CgkJCXVwZGF0ZVNlYXRzKGlvdF9zZWF0c19tc2csIGJhY2t1cF9tc2cpOyAKICAgICAgICAgCiAgICAgICAgICAgY2guY2xvc2UoKTsKICAgICAgICAgICBjb25uLmNsb3NlKCk7CgkgIH0sIHtub0FjazogdHJ1ZX0pOwoJfSk7CgoJcmV0dXJuIG9rLnRoZW4oZnVuY3Rpb24oX2NvbnN1bWVPaykgewoJCQoJfSk7Cgl9KTsKfSkuY2F0Y2goY29uc29sZS53YXJuKTsKfQogICAgCmZ1bmN0aW9uIHVwZGF0ZVNlYXRzKGlvdF9zZWF0c19tc2csIGJhY2t1cF9tc2cpewoJY29uc29sZS5sb2coYmFja3VwX21zZyk7Cgl2YXIgc2VhdHNfbXNnX2FycmF5ID0gaW90X3NlYXRzX21zZy5zcGxpdCgiLSIpOwoJdmFyIHJvb21fbnVtYmVyID0gc2VhdHNfbXNnX2FycmF5WzBdOwoJdmFyIGlzX3NpdHRpbmcgPSBzZWF0c19tc2dfYXJyYXlbMV07Ly90cnVlIGlmIHNlYXRzLCBmYWxzZSBpZiBsZWF2ZXMKCQoJdmFyIGJhY2t1cF9tc2dfYXJyYXkgPSBiYWNrdXBfbXNnLnNwbGl0KCItIik7IAkKCXZhciBzZWF0c19yb29tXzEgPSBiYWNrdXBfbXNnX2FycmF5WzBdOwoJdmFyIHNlYXRzX3Jvb21fMiA9IGJhY2t1cF9tc2dfYXJyYXlbMV07Cgl2YXIgc2VhdHNfcm9vbV8zID0gYmFja3VwX21zZ19hcnJheVsyXTsKCgoKCXN3aXRjaChyb29tX251bWJlcil7CgkJY2FzZSAiMSI6IGlmKGlzX3NpdHRpbmcgPT0gInRydWUiKSB7c2VhdHNfcm9vbV8xLS07fSBlbHNlIGlmKGlzX3NpdHRpbmcgPT0gImZhbHNlIikge3NlYXRzX3Jvb21fMSsrO30gYnJlYWs7CgkJY2FzZSAiMiI6IGlmKGlzX3NpdHRpbmcgPT0gInRydWUiKSB7c2VhdHNfcm9vbV8yLS07fSBlbHNlIGlmKGlzX3NpdHRpbmcgPT0gImZhbHNlIikge3NlYXRzX3Jvb21fMisrO30gYnJlYWs7CgkJY2FzZSAiMyI6IGlmKGlzX3NpdHRpbmcgPT0gInRydWUiKSB7c2VhdHNfcm9vbV8zLS07fSBlbHNlIGlmKGlzX3NpdHRpbmcgPT0gImZhbHNlIikge3NlYXRzX3Jvb21fMysrO30gYnJlYWs7CgkJZGVmYXVsdDogYnJlYWs7Cgl9CgkKCgluZXdfYmFja3VwX21zZyA9IHNlYXRzX3Jvb21fMSsiLSIrc2VhdHNfcm9vbV8yKyItIitzZWF0c19yb29tXzM7CglzZW5kX3RvX2JhY2t1cF9xdWV1ZShuZXdfYmFja3VwX21zZyk7Cn0KCmZ1bmN0aW9uIHNlbmRfdG9fYmFja3VwX3F1ZXVlKG1zZyl7CglhbXFwLmNvbm5lY3QoJ2FtcXA6Ly9ndWVzdDpndWVzdEAxMC4wLjIuMTU6NTY3MicpLnRoZW4oZnVuY3Rpb24oY29ubikgewoJCXJldHVybiBjb25uLmNyZWF0ZUNoYW5uZWwoKS50aGVuKGZ1bmN0aW9uKGNoKSB7CgkJICAgIHZhciBvayA9IGNoLmFzc2VydFF1ZXVlKEJBQ0tVUF9RVUVVRSwge2R1cmFibGU6IGZhbHNlfSk7CgkJICAgIHJldHVybiBvay50aGVuKGZ1bmN0aW9uKF9xb2spIHsKCQkgICAgY2guc2VuZFRvUXVldWUoQkFDS1VQX1FVRVVFLCBCdWZmZXIuZnJvbShtc2cpKTsKCQkgICAgcmV0dXJuIGNoLmNsb3NlKCk7CgkJICAgIH0pOwoJCX0pLmZpbmFsbHkoZnVuY3Rpb24oKSB7IAoJCSAgICAgICAgCgkJICAgIH0pOwoJfSkuY2F0Y2goY29uc29sZS53YXJuKTsKfQoKZnVuY3Rpb24gYmluMnN0cmluZyhhcnJheSl7CiAgdmFyIHJlc3VsdCA9ICIiOwogIGZvcih2YXIgaSA9IDA7IGkgPCBhcnJheS5sZW5ndGg7ICsraSl7CiAgICByZXN1bHQrPSAoU3RyaW5nLmZyb21DaGFyQ29kZShhcnJheVtpXSkpOwogIH0KICByZXR1cm4gcmVzdWx0Owp9CgoKCgoK
    commands:
      - 'npm install amqplib'
    codeEntryType: sourceCode
  platform: {}
